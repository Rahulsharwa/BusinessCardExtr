<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Card Extractor - Configuration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen flex items-center justify-center p-4">

    <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-8 text-white">
            <h1 class="text-3xl font-bold mb-2">Business Card Extractor</h1>
            <p class="text-blue-100">Configure your extraction job settings below.</p>
        </div>

        <form id="extractionForm" class="p-8 space-y-6">

            <!-- Source Configuration -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Source Configuration (Images)</h2>

                <div>
                    <label for="folderName" class="block text-sm font-medium text-gray-700 mb-1">Folder Name / Drive
                        Link</label>
                    <input type="text" id="folderName" name="folderName"
                        placeholder="e.g., 'Client Uploads' or https://drive.google.com/..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                        required>
                    <p class="text-xs text-gray-500 mt-1">Provide the name of the folder or the direct Google Drive link
                        containing the business card images.</p>
                </div>

                <div>
                    <label for="accessSteps" class="block text-sm font-medium text-gray-700 mb-1">Folder Access Steps /
                        Credentials</label>
                    <textarea id="accessSteps" name="accessSteps" rows="3"
                        placeholder="Paste service account JSON content here, or provide instructions on how to access the folder..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"></textarea>
                    <p class="text-xs text-gray-500 mt-1">If the folder is private, provide the necessary access
                        credentials or share instructions.</p>
                </div>
            </div>

            <!-- Destination Configuration -->
            <div class="space-y-4 pt-4">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Destination Configuration (Results)</h2>

                <div>
                    <label for="sheetUrl" class="block text-sm font-medium text-gray-700 mb-1">Google Sheet URL /
                        ID</label>
                    <input type="text" id="sheetUrl" name="sheetUrl"
                        placeholder="https://docs.google.com/spreadsheets/d/..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                        required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Output Preference</label>
                    <div class="flex items-center space-x-6">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="outputMode" value="append"
                                class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                            <span class="text-gray-700">Append to Existing Sheet</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="outputMode" value="new"
                                class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="text-gray-700">Create New Sheet</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="pt-6">
                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                    Start Extraction Job
                </button>
            </div>

            <div id="statusMessage" class="hidden p-4 rounded-lg text-sm font-medium text-center"></div>

        </form>
    </div>

    <script>
        document.getElementById('extractionForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const btn = this.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'Processing...';

            const statusDiv = document.getElementById('statusMessage');
            statusDiv.classList.add('hidden');
            statusDiv.className = 'hidden p-4 rounded-lg text-sm font-medium text-center'; // Reset classes

            const formData = {
                driveFolderId: document.getElementById('folderName').value,
                sheetId: document.getElementById('sheetUrl').value,
            };

            // Basic extraction from URL helper
            let folderId = formData.driveFolderId.trim();
            if (folderId.includes('/folders/')) {
                const parts = folderId.split('/folders/');
                if (parts.length > 1) {
                    folderId = parts[1].split('?')[0].split('/')[0]; // Handle trailing slashes or query params aggressively
                }
            }

            let sheetId = formData.sheetId.trim();
            if (sheetId.includes('/spreadsheets/d/')) {
                const parts = sheetId.split('/spreadsheets/d/');
                if (parts.length > 1) {
                    sheetId = parts[1].split('/')[0];
                }
            }

            const payload = {
                driveFolderId: folderId || null, // Ensure explicit null if empty, though prompt validation check will fail if null
                sheetId: sheetId,
                recursive: false,
                dryRun: false
            };

            // If folderId extracted is empty/null, Pydantic validator will fail (False == False)
            if (!payload.driveFolderId) {
                statusDiv.innerText = `Error: Could not extract Folder ID. Please check the link.`;
                statusDiv.classList.remove('hidden');
                statusDiv.classList.add('bg-red-100', 'text-red-800');
                btn.disabled = false;
                btn.innerText = originalText;
                return;
            }

            console.log("Sending payload:", payload);

            try {
                const response = await fetch('/batch/folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    statusDiv.innerText = `Job Started! Processed ${result.filesProcessed} files.`;
                    statusDiv.classList.remove('hidden');
                    statusDiv.classList.add('bg-green-100', 'text-green-800');
                } else {
                    const error = await response.json();
                    console.error("API Error:", error);
                    let params = '';
                    if (error.detail) {
                        if (typeof error.detail === 'string') {
                            params = error.detail;
                        } else if (Array.isArray(error.detail)) {
                            params = error.detail.map(e => `${e.loc.pop()}: ${e.msg}`).join(', ');
                        } else {
                            params = JSON.stringify(error.detail);
                        }
                    }
                    statusDiv.innerText = `Error: ${params || 'Unknown error occurred'}`;
                    statusDiv.classList.remove('hidden');
                    statusDiv.classList.add('bg-red-100', 'text-red-800');
                }
            } catch (err) {
                console.error("Network Error:", err);
                statusDiv.innerText = `Network Error: ${err.message}`;
                statusDiv.classList.remove('hidden');
                statusDiv.classList.add('bg-red-100', 'text-red-800');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });
    </script>
</body>

</html>